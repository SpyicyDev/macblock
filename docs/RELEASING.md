# Releasing macblock

This repo uses tag-based releases (`vX.Y.Z`). Pushing a version tag triggers GitHub Actions to:

1. Run checks (format, lint, typecheck, tests)
2. Build `sdist` and `wheel`
3. Publish the package to PyPI (trusted publishing)
4. Create a GitHub Release with notes generated by `git-cliff`
5. Bump the Homebrew formula in `SpyicyDev/homebrew-formulae`

## Prerequisites

### Local tools

- `uv`
- `just`
- `git-cliff`

On macOS:

```bash
brew install just git-cliff
```

### PyPI trusted publishing (one-time)

Releases publish to PyPI using OIDC (no long-lived API token in GitHub).

1. Create the project on PyPI (the first publish creates it).
2. In the PyPI project settings, add a **Trusted Publisher** for GitHub Actions:
   - Owner/Repo: `SpyicyDev/macblock`
   - Workflow: `.github/workflows/release.yml`
   - Environment: *(not used)*
3. Ensure the workflow job has `permissions: id-token: write`.

### GitHub secret (one-time)

Homebrew updates are performed by `mislav/bump-homebrew-formula-action`, which needs a token that can push to the tap repo.

1. Create a GitHub **Personal Access Token (classic)** with scopes:
   - `repo`
   - `workflow`

2. Add it to this repo as an Actions secret:
   - Name: `HOMEBREW_TAP_TOKEN`
   - Value: the PAT

If `HOMEBREW_TAP_TOKEN` is missing, the release will still succeed, but the Homebrew bump step will be skipped with a warning.

Note: the tap formula needs a real release tarball + SHA256 to be installable. If the tap still contains a placeholder `sha256`, publish a new `vX.Y.Z` release and the workflow will rewrite the formula with the correct URL + SHA.

## Creating a release

1. Prepare the release commit + tag:

```bash
just release 0.2.0
```

This updates `pyproject.toml`, regenerates `CHANGELOG.md`, runs `just ci`, commits, and creates the tag.

2. Publish:

```bash
git push origin main v0.2.0
```

## Notes

- Tags that contain `-` (e.g. `v0.2.0-beta.1`) are treated as prereleases and will **not** publish to PyPI or bump Homebrew.

## If PyPI publish is skipped or fails

PyPI publishing is skipped for prerelease tags (those containing `-`). For a stable tag, if the publish step fails:

- First check the GitHub Actions logs for the exact PyPI error.
- Common causes: version already exists on PyPI, trusted publisher is not configured for the repo/workflow, or the job is missing `id-token: write`.

If you need to publish manually, build and upload from a clean working tree:

```bash
rm -rf dist
uv build
uv tool run --from twine twine check dist/*

export TWINE_USERNAME=__token__
export TWINE_PASSWORD=<pypi-token>
uv tool run --from twine twine upload --repository-url https://upload.pypi.org/legacy/ dist/*
```

## If Homebrew update is skipped or fails

Manually update the tap:

```bash
VERSION=0.2.0
SHA256=$(curl -sL "https://github.com/SpyicyDev/macblock/archive/refs/tags/v${VERSION}.tar.gz" | shasum -a 256 | awk '{print $1}')

git clone git@github.com:SpyicyDev/homebrew-formulae.git
cd homebrew-formulae

# Update Formula/macblock.rb URL + sha256, then commit and push
```

## Version format

Use semantic versioning: `MAJOR.MINOR.PATCH`.
